<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Listado de Productos</title>
    {% load static %}
    <link rel="stylesheet" href="{% static 'css/bootstrap.min.css' %}">
    <link rel="stylesheet" href="{% static 'css/estilos.css' %}">
</head>
<body>
    <div class="container mt-5">
        <h2 class="mb-4 text-center text-white">Listado de Productos</h2>

        <a href="{% url 'crear_producto' %}" class="btn btn-primary mb-3">AÑADIR PRODUCTO</a>
        <!-- Botón que abre el modal -->
<button type="button" class="btn btn-primary mb-3" data-bs-toggle="modal" data-bs-target="#confirmDownloadModal">
    Descargar PDF
</button>


        <table class="table table-striped table-dark table-hover">
            {% if messages %}
            <div class="alert alert-success" role="alert">
                {% for message in messages %}
                {{ message }}
                {% endfor %}
            </div>
            {% endif %}
        
<br>
        <!-- Formulario de filtro -->
        <form method="GET" action="{% url 'listar_productos' %}" id="filtroForm">
            <div class="row">
                <div class="col-md-2">
                    <label for="marca" class="text-white">Marca:</label>
                    <select name="marca" id="marca" class="form-control">
                        <option value="">-- Seleccionar Marca --</option>
                        {% for marca in marcas %}
                        <option value="{{ marca.cod_mar }}" {% if request.GET.marca == marca.cod_mar|stringformat:"s" %}selected{% endif %}>{{ marca.nom_mar }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-2">
                    <label for="categoria" class="text-white">Categoría:</label>
                    <select name="categoria" id="categoria" class="form-control">
                        <option value="">-- Seleccionar Categoría --</option>
                        {% for categoria in categorias %}
                        <option value="{{ categoria.cod_cat }}" {% if request.GET.categoria == categoria.cod_cat|stringformat:"s" %}selected{% endif %}>{{ categoria.nom_cat }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-2">
                    <label for="precio" class="text-white">Precio Máximo:</label>
                    <input type="number" name="precio" id="precio" class="form-control" value="{{ request.GET.precio }}">
                </div>
                <div class="col-md-2">
                    <label for="estado" class="text-white">Estado:</label>
                    <select name="estado" id="estado" class="form-control">
                        <option value="">-- Seleccionar Estado --</option>
                        <option value="A" {% if request.GET.estado == 'A' %}selected{% endif %}>Activo</option>
                        <option value="I" {% if request.GET.estado == 'I' %}selected{% endif %}>Inactivo</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <br>
                    <button type="submit" class="btn btn-primary" id="submitBtn" {% if request.GET %}disabled{% endif %}>Aplicar Filtro</button>
                </div>
                <div class="col-md-2">
                    <br>
                    <a href="{% url 'listar_productos' %}" class="btn btn-secondary" id="cancelBtn">Cancelar Filtro</a>
                </div>
            </div>
        </form>
        <br>
        <!-- Tabla de productos -->
        <table class="table table-striped table-dark table-hover">
            <thead>
                <tr>
                    <th class="text-center">ID</th>
                    <th class="text-center">Nombre</th>
                    <th class="text-center">Precio</th>
                    <th class="text-center">Categoría</th>
                    <th class="text-center">Marca</th>
                    <th class="text-center">Estado</th>
                    <th class="text-center">Acciones</th>
                </tr>
            </thead>
            <tbody>
                {% for producto in productos %}
                <tr>
                    <td class="text-center">{{ producto.cod_prod }}</td>
                    <td>{{ producto.nom_prod }}</td>
                    <td class="text-center">{{ producto.pre_prod }}</td>
                    <td class="text-center">{{ producto.fky_cat.nom_cat }}</td>
                    <td class="text-center">{{ producto.fky_mar.nom_mar }}</td>
                    <td class="text-center">{{ producto.est_prod }}</td>
                    <td class="text-center">
                        <a href="{% url 'editar_producto' producto.pk %}" class="btn btn-sm btn-primary">Editar</a>
                        
                        {% if producto.est_prod == 'A' %}
                        <!-- Si el estado es 'A' (Activo), mostrar botón de eliminación -->
                        <a href="#" class="btn btn-sm btn-danger" data-bs-toggle="modal" data-bs-target="#confirmDeleteProducto" data-url="{% url 'eliminar_producto' producto.pk %}">Desactivar</a>
                        {% else %}
                        <!-- Si el estado es 'I' (Inactivo), deshabilitar botón y mostrar modal de aviso -->
                        <a href="#" class="btn btn-sm btn-secondary" data-bs-toggle="modal" data-bs-target="#alreadyDeletedModal" disabled>Inactivo</a>
                        {% endif %}
                    </td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="7" class="text-center">No se encontraron productos.</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        

        <!-- Modal de confirmación -->
        <div class="modal fade" id="confirmDeleteProducto" tabindex="-1" aria-labelledby="confirmDeleteProductoLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="confirmDeleteProductoLabel">Confirmar Desactivación</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        ¿Estás seguro de que deseas Desactivar este producto?<br>
                        Podrás Activarlo nuevamente editando el "Estado del Producto"
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <form method="POST" id="deleteForm">
                            {% csrf_token %}
                            <button type="submit" class="btn btn-danger">Desactivar</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <!-- Modal de Aviso para Producto Eliminado -->
<div class="modal fade" id="alreadyDeletedModal" tabindex="-1" aria-labelledby="alreadyDeletedModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="alreadyDeletedModalLabel">Aviso</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          Este producto está inactivo. <br>
          Dirijase a Editar > Estado del Producto para Activarlo Nuevamente
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Modal de confirmación PDF -->
<div class="modal fade" id="confirmDownloadModal" tabindex="-1" aria-labelledby="confirmDownloadModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="confirmDownloadModalLabel">Confirmar descarga</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                ¿Estás seguro de que deseas descargar el PDF con la lista de productos?
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <!-- Botón para confirmar y descargar el PDF -->
                <a href="{% url 'generar_pdf_productos' %}" class="btn btn-primary">Descargar PDF</a>
            </div>
        </div>
    </div>
</div>




        
        <div class="container mt-3" class="d-flex justify-content-around">
            <a href="{% url 'listar_categorias' %}" class="btn btn-primary mb-3">Gestionar Categorias</a>

            <a href="{% url 'listar_marcas' %}" class="btn btn-primary mb-3">Gestionar Marcas</a>
        </div>
       
        <div class="d-flex justify-content-center mt-5">
            <a href="{% url 'home' %}" class="btn btn-secondary w-25">Volver</a>
        </div>
    </div>

    <!-- Bootstrap JS and dependencies -->
    <script src="{% static 'js/bootstrap.bundle.min.js' %}"></script>

    <!-- Script para pasar la URL de eliminación al modal -->
    <script>
        var confirmDeleteProducto = document.getElementById('confirmDeleteProducto');
        confirmDeleteProducto.addEventListener('show.bs.modal', function (event) {
            var button = event.relatedTarget; // Botón que activó el modal
            var url = button.getAttribute('data-url'); // Obtener la URL del botón "Eliminar"
            
            var deleteForm = document.getElementById('deleteForm');
            deleteForm.action = url; // Asignar la URL al formulario
        });
    </script>
    <script>
document.addEventListener("DOMContentLoaded", function() {
    const submitBtn = document.getElementById("submitBtn");
    const cancelBtn = document.getElementById("cancelBtn");
    const filtroForm = document.getElementById("filtroForm");

    // Habilitar el botón de "Aplicar Filtro" cuando se cancele el filtro
    cancelBtn.addEventListener("click", function() {
        submitBtn.disabled = false;
    });

    // Deshabilitar el botón de "Aplicar Filtro" si hay filtros activos
    if (filtroForm.querySelectorAll('input[value], select[value]').length > 0) {
        submitBtn.disabled = true;
    }
});
    </script>
        
</body>
</html>
